{% extends "base.html" %}

{% block title %}Set Goals{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Set Your Nutritional Goals</h1>
    <form method="POST" action="{{ url_for('goals.goals') }}">
        {{ form.hidden_tag() }}

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mt-4 mb-0">Personal Information</h2>
            <button type="button" id="calculate-bmr-btn" class="btn btn-outline-info mt-3">Calculate BMR & Macros</button>
        </div>
        <div class="row">
            <div class="col-lg-4 mb-3">
                {{ form.age.label(class="form-label") }}
                {{ form.age(class="form-control") }}
            </div>
            <div class="col-lg-4 mb-3">
                {{ form.gender.label(class="form-label") }}
                {{ form.gender(class="form-select") }}
            </div>
            {% if current_user.measurement_system == 'us' %}
            <div class="col-lg-4 mb-3">
                <label class="form-label">Height</label>
                <div class="input-group">
                    {{ form.height_ft(class="form-control", placeholder="ft", value=(form.height_ft.data | round(2)) if form.height_ft.data else '') }}
                    {{ form.height_in(class="form-control", placeholder="in", value=(form.height_in.data | round(2)) if form.height_in.data else '') }}
                </div>
            </div>
            {% else %}
            <div class="col-lg-4 mb-3">
                {{ form.height_cm.label(class="form-label") }}
                {{ form.height_cm(class="form-control", value=(form.height_cm.data | round(2)) if form.height_cm.data else '') }}
            </div>
            {% endif %}
        </div>

        <div class="row">
            <div class="col-lg-6 mb-3">
                {% if current_user.measurement_system == 'us' %}
                    {{ form.weight_lbs.label(class="form-label") }}
                    {{ form.weight_lbs(class="form-control", value=(form.weight_lbs.data | round(2)) if form.weight_lbs.data else '') }}
                {% else %}
                    {{ form.weight_kg.label(class="form-label") }}
                    {{ form.weight_kg(class="form-control", value=(form.weight_kg.data | round(2)) if form.weight_kg.data else '') }}
                {% endif %}
            </div>
            <div class="col-lg-6 mb-3">
                {{ form.body_fat_percentage.label(class="form-label") }}
                {{ form.body_fat_percentage(class="form-control", value=(form.body_fat_percentage.data | round(2)) if form.body_fat_percentage.data else '') }}
            </div>
        </div>

        <div class="alert alert-info mt-4" id="bmr-display" {% if not bmr %}style="display: none;"{% endif %} role="alert">
            Your estimated Basal Metabolic Rate (BMR) is: <strong id="bmr-value">{{ "%.0f"|format(bmr) if bmr else '' }}</strong> kcal/day.
            <small class="d-block">Calculated using the <strong id="bmr-formula">{{ formula_name if formula_name else '' }}</strong> formula.</small>
        </div>

        <h2 class="mt-4 mb-3">Nutritional Goals</h2>
        <div class="mb-3">
            {{ form.diet_preset.label(class="form-label") }}
            {{ form.diet_preset(class="form-select") }}
        </div>
        <div class="row">
            <div class="col-lg-3 mb-3">
                {{ form.calories.label(class="form-label") }}
                {{ form.calories(class="form-control") }}
            </div>
            <div class="col-lg-3 mb-3">
                {{ form.protein.label(class="form-label") }}
                {{ form.protein(class="form-control") }}
            </div>
            <div class="col-lg-3 mb-3">
                {{ form.carbs.label(class="form-label") }}
                {{ form.carbs(class="form-control") }}
            </div>
            <div class="col-lg-3 mb-3">
                {{ form.fat.label(class="form-label") }}
                {{ form.fat(class="form-control") }}
            </div>
        </div>

        <h2 class="mt-4 mb-3">Exercise Goals</h2>
        <div class="row">
            <div class="col-lg-4 mb-3">
                {{ form.calories_burned_goal_weekly.label(class="form-label") }}
                {{ form.calories_burned_goal_weekly(class="form-control") }}
            </div>
            <div class="col-lg-4 mb-3">
                {{ form.exercises_per_week_goal.label(class="form-label") }}
                {{ form.exercises_per_week_goal(class="form-control") }}
            </div>
            <div class="col-lg-4 mb-3">
                {{ form.minutes_per_exercise_goal.label(class="form-label") }}
                {{ form.minutes_per_exercise_goal(class="form-control") }}
            </div>
        </div>

        <h2 class="mt-4 mb-3">Body Composition Goals</h2>
        <div class="row">
            {% if current_user.measurement_system == 'us' %}
            <div class="col-lg-4 mb-3">
                {{ form.weight_goal_lbs.label(class="form-label") }}
                {{ form.weight_goal_lbs(class="form-control", value=(form.weight_goal_lbs.data | round(2)) if form.weight_goal_lbs.data else '') }}
            </div>
            {% else %}
            <div class="col-lg-4 mb-3">
                {{ form.weight_goal_kg.label(class="form-label") }}
                {{ form.weight_goal_kg(class="form-control", value=(form.weight_goal_kg.data | round(2)) if form.weight_goal_kg.data else '') }}
            </div>
            {% endif %}
            <div class="col-lg-4 mb-3">
                {{ form.body_fat_percentage_goal.label(class="form-label") }}
                {{ form.body_fat_percentage_goal(class="form-control", value=(form.body_fat_percentage_goal.data | round(2)) if form.body_fat_percentage_goal.data else '') }}
            </div>
            {% if current_user.measurement_system == 'us' %}
            <div class="col-lg-4 mb-3">
                {{ form.waist_in_goal.label(class="form-label") }}
                {{ form.waist_in_goal(class="form-control", value=(form.waist_in_goal.data | round(2)) if form.waist_in_goal.data else '') }}
            </div>
            {% else %}
            <div class="col-lg-4 mb-3">
                {{ form.waist_cm_goal.label(class="form-label") }}
                {{ form.waist_cm_goal(class="form-control", value=(form.waist_cm_goal.data | round(2)) if form.waist_cm_goal.data else '') }}
            </div>
            {% endif %}
        </div>

        <button type="submit" class="btn btn-outline-success">Save Goals</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const calculateBtn = document.getElementById('calculate-bmr-btn');
    const dietPresetSelect = document.getElementById('diet_preset');
    const caloriesField = document.getElementById('calories');
    const proteinField = document.getElementById('protein');
    const carbsField = document.getElementById('carbs');
    const fatField = document.getElementById('fat');
    
    const bmrDisplay = document.getElementById('bmr-display');
    const bmrValue = document.getElementById('bmr-value');
    const bmrFormula = document.getElementById('bmr-formula');

    function calculateBmrAndGoals() {
        const age = document.getElementById('age').value;
        const gender = document.getElementById('gender').value;
        const bodyFatInput = document.getElementById('body_fat_percentage');
        const body_fat_percentage = bodyFatInput ? bodyFatInput.value : null;
        const diet_preset = dietPresetSelect.value;

        let payload = { age, gender, diet_preset };
        if (body_fat_percentage) {
            payload.body_fat_percentage = body_fat_percentage;
        }
        
        if ("{{ current_user.measurement_system }}" === "us") {
            const height_ft = document.getElementById('height_ft');
            const height_in = document.getElementById('height_in');
            const weight_lbs = document.getElementById('weight_lbs');
            if (height_ft) payload.height_ft = height_ft.value;
            if (height_in) payload.height_in = height_in.value;
            if (weight_lbs) payload.weight_lbs = weight_lbs.value;
        } else {
            const height_cm = document.getElementById('height_cm');
            const weight_kg = document.getElementById('weight_kg');
            if (height_cm) payload.height_cm = height_cm.value;
            if (weight_kg) payload.weight_kg = weight_kg.value;
        }

        fetch('{{ url_for("goals.calculate_bmr_route") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                bmrDisplay.style.display = 'none';
                return Promise.reject(`Server responded with ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.bmr) {
                bmrValue.textContent = data.bmr.toFixed(0);
                bmrFormula.textContent = data.formula;
                bmrDisplay.style.display = 'block';

                if (data.adjusted_goals && diet_preset) {
                    caloriesField.value = data.adjusted_goals.calories;
                    proteinField.value = data.adjusted_goals.protein;
                    carbsField.value = data.adjusted_goals.carbs;
                    fatField.value = data.adjusted_goals.fat;
                }
            } else {
                bmrDisplay.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('BMR Calculation Error:', error);
            bmrDisplay.style.display = 'none';
        });
    }

    // Attach event listener to the button
    if (calculateBtn) {
        calculateBtn.addEventListener('click', calculateBmrAndGoals);
    }

    // Attach delegated event listeners for real-time updates
    if (form) {
        form.addEventListener('input', calculateBmrAndGoals);
        form.addEventListener('change', calculateBmrAndGoals);
    }

    // Initial calculation on page load
    calculateBmrAndGoals();
});
</script>
{% endblock %}