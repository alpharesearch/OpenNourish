{% extends "base.html" %}

{% block title %}Set Goals{% endblock %}

{% block content %}
<a id="prev-page-link" href="{{ url_for('fasting.index') }}" style="display: none;"></a>
<a id="next-page-link" href="{{ url_for('settings.settings') }}" style="display: none;"></a>
<div class="container mt-4">
    <form method="POST" action="{{ url_for('goals.goals') }}">
        <!-- PAGE HEADER -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Set Your Goals</h1>
            <button type="submit" class="btn btn-outline-primary"><i class="bi bi-check2-circle"></i> Save Goals</button>
        </div>

        {{ form.hidden_tag() }}

        <div class="alert alert-info mb-4" id="bmr-display" {% if not bmr %}style="display: none;"{% endif %} role="alert">
            Your estimated Basal Metabolic Rate (BMR) is: <strong id="bmr-value">{{ "%.0f"|format(bmr) if bmr else '' }}</strong> kcal/day.
            <small class="d-block">Calculated using the <strong id="bmr-formula">{{ formula_name if formula_name else '' }}</strong> formula.</small>
        </div>

        <div class="alert alert-info mb-4" id="bmi-display" {% if not bmi %}style="display: none;"{% endif %} role="alert">
            Your estimated Body Mass Index (BMI) is: <strong id="bmi-value">{{ "%.1f"|format(bmi) if bmi else '' }}</strong>.
        </div>

        <!-- CARD: Help & Guidelines -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">
                    <a href="#guidelines-collapse" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="guidelines-collapse" class="text-decoration-none">
                        <i class="bi bi-info-circle"></i> Help & Guidelines
                    </a>
                </h2>
            </div>
            <div class="collapse" id="guidelines-collapse">
                <div class="card-body">
                    <!-- BMI Section -->
                    <h4>Body Weight Guidelines: Body Mass Index (BMI)</h4>
                    <p>The most common starting point for assessing healthy weight is the Body Mass Index (BMI), which is a measure of body fat based on height and weight.</p>
                    <h5>BMI Categories for Adults:</h5>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr><th>Category</th><th>BMI Range</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Underweight</td><td>Below 18.5</td></tr>
                            <tr><td>Healthy Weight</td><td>18.5 to 24.9</td></tr>
                            <tr><td>Overweight</td><td>25.0 to 29.9</td></tr>
                            <tr><td>Obesity</td><td>30.0 and above</td></tr>
                        </tbody>
                    </table>
                    <p><small>It's important to note that BMI is a screening tool and doesn't account for factors like muscle mass, so it may not be a perfect indicator for everyone, such as athletes.</small></p>
                    <hr>

                    <!-- Body Fat % Section -->
                    <h4>Body Fat Percentage Guidelines</h4>
                    <p>For a more nuanced understanding of body composition, body fat percentage is a key metric. The American Council on Exercise (ACE) provides widely accepted ranges, which differ for men and women and can be further broken down by fitness level.</p>
                    <h5>General Body Fat Percentage Categories:</h5>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr><th>Description</th><th>Women</th><th>Men</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Essential Fat</td><td>10-13%</td><td>2-5%</td></tr>
                            <tr><td>Athletes</td><td>14-20%</td><td>6-13%</td></tr>
                            <tr><td>Fitness</td><td>21-24%</td><td>14-17%</td></tr>
                            <tr><td>Average/Acceptable</td><td>25-31%</td><td>18-24%</td></tr>
                            <tr><td>Obese</td><td>32%+</td><td>25%+</td></tr>
                        </tbody>
                    </table>
                    <br>
                    <h5>Healthy Body Fat Percentage by Age:</h5>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr><th>Age</th><th>Women</th><th>Men</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>20-39</td><td>21-32%</td><td>8-19%</td></tr>
                            <tr><td>40-59</td><td>23-33%</td><td>11-21%</td></tr>
                            <tr><td>60-79</td><td>24-35%</td><td>13-24%</td></tr>
                        </tbody>
                    </table>
                    <hr>

                    <!-- Waist Circumference Section -->
                    <h4>Waist Circumference</h4>
                    <p>Waist circumference is another important indicator of health risk, particularly for conditions like type 2 diabetes and heart disease.</p>
                    
                    {% if current_user.gender == 'Male' %}
                    <p>A waist circumference above <strong>102 cm (40 inches)</strong> for men is associated with an increased health risk.
                    {% elif current_user.gender == 'Female' %}
                    <p>A waist circumference above <strong>88 cm (35 inches)</strong> for women is associated with an increased health risk.
                    {% endif %}
                    
                    {% if latest_waist_cm is not none %}
                        Your most recent measurement is <strong>{{ latest_waist_cm | round(1) }} cm</strong>.
                    {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- CARD 1: Body Composition Goals -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Body Composition Goals
                <span class="h6 text-muted" id="target-bmi-header-display">
                    {% if target_bmi %}
                        (Target BMI: {{ "%.1f"|format(target_bmi) }})
                    {% endif %}
                </span></h2>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if current_user.measurement_system == 'us' %}
                    <div class="col-lg-4 mb-3">
                        <label class="form-label" for="weight_goal_lbs">{{ form.weight_goal_lbs.label.text }} {% if form.weight_goal_lbs.data is not none %}<small class="text-muted">(current: {{ form.weight_goal_lbs.data | round(2) }})</small>{% endif %}</label>
                        {{ form.weight_goal_lbs(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    {% else %}
                    <div class="col-lg-4 mb-3">
                        <label class="form-label" for="weight_goal_kg">{{ form.weight_goal_kg.label.text }} {% if form.weight_goal_kg.data is not none %}<small class="text-muted">(current: {{ form.weight_goal_kg.data | round(2) }})</small>{% endif %}</label>
                        {{ form.weight_goal_kg(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    {% endif %}
                    <div class="col-lg-4 mb-3">
                        <label class="form-label" for="body_fat_percentage_goal">{{ form.body_fat_percentage_goal.label.text }} {% if form.body_fat_percentage_goal.data is not none %}<small class="text-muted">(current: {{ form.body_fat_percentage_goal.data | round(2) }}%)</small>{% endif %}</label>
                        {{ form.body_fat_percentage_goal(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    <div class="col-lg-4 mb-3">
                    {% if current_user.measurement_system == 'us' %}
                        <label class="form-label" for="waist_in_goal">{{ form.waist_in_goal.label.text }} {% if form.waist_in_goal.data is not none %}<small class="text-muted">(current: {{ form.waist_in_goal.data | round(2) }})</small>{% endif %}</label>
                        {{ form.waist_in_goal(class="form-control", placeholder="New goal", value='') }}
                    {% else %}
                        <label class="form-label" for="waist_cm_goal">{{ form.waist_cm_goal.label.text }} {% if form.waist_cm_goal.data is not none %}<small class="text-muted">(current: {{ form.waist_cm_goal.data | round(2) }})</small>{% endif %}</label>
                        {{ form.waist_cm_goal(class="form-control", placeholder="New goal", value='') }}
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 2: Nutritional Goals -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Nutritional Goals</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.goal_modifier.label(class="form-label") }}
                        {{ form.goal_modifier(class="form-select") }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.diet_preset.label(class="form-label") }}
                        {{ form.diet_preset(class="form-select") }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-3 mb-3">
                        <label class="form-label" for="calories">{{ form.calories.label.text }} {% if form.calories.data is not none %}<small class="text-muted">(current: {{ form.calories.data | round | int }})</small>{% endif %}</label>
                        {{ form.calories(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    <div class="col-lg-3 mb-3">
                        <label class="form-label" for="protein">{{ form.protein.label.text }} {% if form.protein.data is not none %}<small class="text-muted">(current: {{ form.protein.data | round | int }}g)</small>{% endif %}</label>
                        {{ form.protein(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    <div class="col-lg-3 mb-3">
                        <label class="form-label" for="carbs">{{ form.carbs.label.text }} {% if form.carbs.data is not none %}<small class="text-muted">(current: {{ form.carbs.data | round | int }}g)</small>{% endif %}</label>
                        {{ form.carbs(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    <div class="col-lg-3 mb-3">
                        <label class="form-label" for="fat">{{ form.fat.label.text }} {% if form.fat.data is not none %}<small class="text-muted">(current: {{ form.fat.data | round | int }}g)</small>{% endif %}</label>
                        {{ form.fat(class="form-control", placeholder="New goal", value='') }}
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 3: Exercise Goals -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Exercise Goals</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <label class="form-label" for="calories_burned_goal_weekly">{{ form.calories_burned_goal_weekly.label.text }} {% if form.calories_burned_goal_weekly.data is not none %}<small class="text-muted">(current: {{ form.calories_burned_goal_weekly.data | round | int }})</small>{% endif %}</label>
                        {{ form.calories_burned_goal_weekly(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    <div class="col-lg-4 mb-3">
                        <label class="form-label" for="exercises_per_week_goal">{{ form.exercises_per_week_goal.label.text }} {% if form.exercises_per_week_goal.data is not none %}<small class="text-muted">(current: {{ form.exercises_per_week_goal.data | round | int }})</small>{% endif %}</label>
                        {{ form.exercises_per_week_goal(class="form-control", placeholder="New goal", value='') }}
                    </div>
                    <div class="col-lg-4 mb-3">
                        <label class="form-label" for="minutes_per_exercise_goal">{{ form.minutes_per_exercise_goal.label.text }} {% if form.minutes_per_exercise_goal.data is not none %}<small class="text-muted">(current: {{ form.minutes_per_exercise_goal.data | round | int }})</small>{% endif %}</label>
                        {{ form.minutes_per_exercise_goal(class="form-control", placeholder="New goal", value='') }}
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 4: Fasting -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Fasting</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <label class="form-label" for="default_fasting_hours">{{ form.default_fasting_hours.label.text }} {% if form.default_fasting_hours.data is not none %}<small class="text-muted">(current: {{ form.default_fasting_hours.data | round(1) }})</small>{% endif %}</label>
                        {{ form.default_fasting_hours(class="form-control", placeholder="New goal", value='') }}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const weightGoalKgInput = document.getElementById('weight_goal_kg');
    const weightGoalLbsInput = document.getElementById('weight_goal_lbs');
    const targetBmiDisplay = document.getElementById('target-bmi-header-display');
    const userHeightCm = {{ current_user.height_cm|default('null') }};

    function updateTargetBmi() {
        if (!userHeightCm) return;

        let weightKg;
        if (weightGoalKgInput && weightGoalKgInput.value) {
            weightKg = parseFloat(weightGoalKgInput.value);
        } else if (weightGoalLbsInput && weightGoalLbsInput.value) {
            const weightLbs = parseFloat(weightGoalLbsInput.value);
            weightKg = weightLbs / 2.20462; // lbs to kg conversion
        } else {
            // If input is empty, revert to server-rendered value if it exists
            const initialTargetBmi = "{{ '%.1f'|format(target_bmi) if target_bmi else '' }}";
            if (initialTargetBmi) {
                targetBmiDisplay.innerHTML = `(Target BMI: ${initialTargetBmi})`;
            } else {
                targetBmiDisplay.innerHTML = '';
            }
            return;
        }

        if (!isNaN(weightKg) && weightKg > 0) {
            const heightM = userHeightCm / 100;
            const bmi = weightKg / (heightM * heightM);
            targetBmiDisplay.innerHTML = `(Target BMI: ${bmi.toFixed(1)})`;
        } else {
            targetBmiDisplay.innerHTML = '';
        }
    }

    if (weightGoalKgInput) {
        weightGoalKgInput.addEventListener('input', updateTargetBmi);
    }
    if (weightGoalLbsInput) {
        weightGoalLbsInput.addEventListener('input', updateTargetBmi);
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const goalModifierSelect = document.getElementById('goal_modifier');
    const dietPresetSelect = document.getElementById('diet_preset');
    const caloriesField = document.getElementById('calories');
    const proteinField = document.getElementById('protein');
    const carbsField = document.getElementById('carbs');
    const fatField = document.getElementById('fat');
    const bmrValueElement = document.getElementById('bmr-value');
    const nutrientFields = [caloriesField, proteinField, carbsField, fatField];
    const form = document.querySelector('form');

    function setNutrientFieldsDisabled(disabled) {
        nutrientFields.forEach(field => field.disabled = disabled);
    }

    function applyPresetToMacros() {
        const dietPreset = dietPresetSelect.value;
        const calories = parseFloat(caloriesField.value);
        if (dietPreset !== 'manual' && !isNaN(calories) && calories > 0) {
            const dietPresets = {{ diet_presets|tojson }};
            const preset = dietPresets[dietPreset];
            if (preset) {
                proteinField.value = Math.round((calories * preset.protein) / 4);
                carbsField.value = Math.round((calories * preset.carbs) / 4);
                fatField.value = Math.round((calories * preset.fat) / 9);
            }
        }
    }

    function updateNutrientGoals() {
        const goalModifier = goalModifierSelect.value;
        const dietPreset = dietPresetSelect.value;

        if (goalModifier === 'manual') {
            setNutrientFieldsDisabled(false);
            applyPresetToMacros(); // Apply preset based on current calories
            return;
        }

        if (dietPreset === 'manual') {
            setNutrientFieldsDisabled(false);
            return;
        }

        // BMR-based calculation
        const bmrText = bmrValueElement.textContent;
        if (!bmrText) return;
        const bmr = parseFloat(bmrText);
        if (isNaN(bmr)) return;

        setNutrientFieldsDisabled(true);

        let adjustedCalories;
        switch (goalModifier) {
            case 'vlcd':
                adjustedCalories = 800;
                break;
            case 'lcd':
                adjustedCalories = 1200;
                break;
            case 'safe_max_loss':
                adjustedCalories = bmr - 750;
                break;
            case 'moderate_loss':
                adjustedCalories = bmr - 500;
                break;
            case 'maintain':
                adjustedCalories = bmr;
                break;
            case 'moderate_gain':
                adjustedCalories = bmr * 1.10;
                break;
            case 'safe_max_gain':
                adjustedCalories = bmr * 1.20;
                break;
            default:
                adjustedCalories = bmr;
        }
        
        if (goalModifier.includes('loss')) {
            adjustedCalories = Math.max(adjustedCalories, 1200);
        }

        const dietPresets = {{ diet_presets|tojson }};
        if (dietPresets[dietPreset]) {
            caloriesField.value = Math.round(adjustedCalories);
            // After setting calories, we can re-use the macro calculation logic
            applyPresetToMacros();
        }
    }

    goalModifierSelect.addEventListener('change', updateNutrientGoals);
    dietPresetSelect.addEventListener('change', updateNutrientGoals);
    caloriesField.addEventListener('input', () => {
        if (goalModifierSelect.value === 'manual') {
            applyPresetToMacros();
        }
    });

    if (form) {
        form.addEventListener('submit', function() {
            setNutrientFieldsDisabled(false);
        });
    }

    // Initial calculation on page load
    updateNutrientGoals();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const prevLink = document.getElementById('prev-page-link');
    const nextLink = document.getElementById('next-page-link');

    if (prevLink || nextLink) {
        let touchstartX = 0;
        let touchendX = 0;
        let touchstartY = 0;
        let touchendY = 0;
        const swipeThreshold = 100;

        document.addEventListener('touchstart', function (event) {
            touchstartX = event.changedTouches[0].screenX;
            touchstartY = event.changedTouches[0].screenY;
        }, { passive: true });

        document.addEventListener('touchend', function (event) {
            touchendX = event.changedTouches[0].screenX;
            touchendY = event.changedTouches[0].screenY;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            const swipeDistanceX = touchendX - touchstartX;
            const swipeDistanceY = touchendY - touchstartY;

            if (Math.abs(swipeDistanceX) > swipeThreshold && Math.abs(swipeDistanceX) > Math.abs(swipeDistanceY)) {
                if (swipeDistanceX < 0 && nextLink) {
                    // Swiped left
                    window.location.href = nextLink.href;
                } else if (swipeDistanceX > 0 && prevLink) {
                    // Swiped right
                    window.location.href = prevLink.href;
                }
            }
        }
    }
});
</script>
{% endblock %}
