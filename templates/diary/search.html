{% extends "base.html" %}

{% block content %}
<div class="container">
    {% if log_date %}
    <h1 class="mt-4">Add Food to {{ meal_name }} on {{ log_date.strftime('%A, %B %d, %Y') }}</h1>
    <form method="POST" action="{{ url_for('diary.search_for_diary', log_date_str=log_date.isoformat(), meal_name=meal_name) }}" class="mb-4">
    {% elif meal %}
    <h1 class="mt-4">Add Food to Meal: {{ meal.name }}</h1>
    <form method="POST" action="{{ url_for('diary.search_for_meal_item', meal_id=meal.id) }}" class="mb-4">
    {% endif %}
        <div class="input-group">
            <input type="text" class="form-control" name="search_term" placeholder="Search for a food...">
            <button class="btn btn-primary" type="submit">Search</button>
        </div>
    </form>

    {% if usda_results or my_food_results or my_meal_results %}
        <h2>Search Results</h2>
        
        <h3>My Foods</h3>
        <ul class="list-group mb-4">
            {% for food in my_food_results %}
            <li class="list-group-item">
                <form action="{% if log_date %}{{ url_for('diary.add_entry') }}{% elif meal %}{{ url_for('diary.add_meal_item', meal_id=meal.id) }}{% endif %}" method="post" class="d-flex justify-content-between align-items-center">
                    {{ food.description }}
                    <div class="d-flex">
                        {% if log_date %}
                        <input type="hidden" name="log_date" value="{{ log_date.isoformat() }}">
                        <input type="hidden" name="meal_name" value="{{ meal_name }}">
                        {% elif meal %}
                        <input type="hidden" name="meal_id" value="{{ meal.id }}">
                        {% endif %}
                        <input type="hidden" name="my_food_id" value="{{ food.id }}">
                        <input type="number" name="amount" class="form-control me-2" placeholder="grams" required>
                        <button type="submit" class="btn btn-success btn-sm">Add</button>
                    </div>
                </form>
            </li>
            {% else %}
            <li class="list-group-item">No results found in your foods.</li>
            {% endfor %}
        </ul>

        <h3>My Meals</h3>
        <ul class="list-group mb-4">
            {% for my_meal in my_meal_results %}
            <li class="list-group-item">
                <form action="{% if log_date %}{{ url_for('diary.add_meal_to_diary') }}{% elif meal %}{{ url_for('diary.add_meal_item', meal_id=meal.id) }}{% endif %}" method="post" class="d-flex justify-content-between align-items-center">
                    {{ my_meal.name }}
                    <div class="d-flex">
                        {% if log_date %}
                        <input type="hidden" name="log_date" value="{{ log_date.isoformat() }}">
                        <input type="hidden" name="meal_name" value="{{ meal_name }}">
                        <input type="hidden" name="meal_id" value="{{ my_meal.id }}">
                        {% elif meal %}
                        <input type="hidden" name="source_meal_id" value="{{ my_meal.id }}">
                        <input type="hidden" name="amount" value="1"> {# Dummy amount, as we're adding items, not the meal itself #}
                        {% endif %}
                        <button type="submit" class="btn btn-success btn-sm">Add</button>
                    </div>
                </form>
            </li>
            {% else %}
            <li class="list-group-item">No results found in your meals.</li>
            {% endfor %}
        </ul>

        <h3>USDA Foods</h3>
        <ul class="list-group">
            {% for food in usda_results %}
            <li class="list-group-item">
                <form action="{% if log_date %}{{ url_for('diary.add_entry') }}{% elif meal %}{{ url_for('diary.add_meal_item', meal_id=meal.id) }}{% endif %}" method="post" class="d-flex justify-content-between align-items-center">
                    {{ food.description }}
                    <div class="d-flex">
                        {% if log_date %}
                        <input type="hidden" name="log_date" value="{{ log_date.isoformat() }}">
                        <input type="hidden" name="meal_name" value="{{ meal_name }}">
                        {% elif meal %}
                        <input type="hidden" name="meal_id" value="{{ meal.id }}">
                        {% endif %}
                        <input type="hidden" name="fdc_id" value="{{ food.fdc_id }}">
                        <input type="number" name="amount" class="form-control me-2" placeholder="grams" required>
                        <button type="submit" class="btn btn-success btn-sm">Add</button>
                    </div>
                </form>
            </li>
            {% else %}
            <li class="list-group-item">No results found in USDA database.</li>
            {% endfor %}
        </ul>
    {% endif %}
</div>
{% endblock %}
