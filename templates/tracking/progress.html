{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">Progress Overview</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-8">
                    {% if chart_labels and weight_data %}
                        <div style="height: 300px;">
                            <canvas id="progressChart"></canvas>
                        </div>
                    {% else %}
                        <p>Log a check-in to see your progress chart!</p>
                    {% endif %}
                </div>
                <div class="col-lg-4 d-flex flex-column justify-content-center">
                    <div class="text-center">
                        <h5>Start Weight</h5>
                        <p class="fs-4">{{ "%.1f"|format(start_weight) }} kg</p>
                    </div>
                    <div class="text-center">
                        <h5>Current Weight</h5>
                        <p class="fs-4">{{ "%.1f"|format(current_weight) }} kg</p>
                    </div>
                    <div class="text-center">
                        <h5>Goal Weight</h5>
                        <p class="fs-4">{{ "%.1f"|format(goal_weight) }} kg</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">New Check-In</h2>
    <form method="POST" action="{{ url_for('tracking.progress') }}" class="mb-5">
        {{ form.hidden_tag() }}
        <div class="row align-items-end">
            <div class="col-lg-3">
                {{ form.checkin_date.label(class="form-label") }}
                {{ form.checkin_date(class="form-control") }}
            </div>
            {% if current_user.measurement_system == 'us' %}
            <div class="col-lg-2">
                {{ form.weight_lbs.label(class="form-label") }}
                {{ form.weight_lbs(class="form-control") }}
            </div>
            <div class="col-lg-2">
                {{ form.waist_in.label(class="form-label") }}
                {{ form.waist_in(class="form-control") }}
            </div>
            {% else %}
            <div class="col-lg-2">
                {{ form.weight_kg.label(class="form-label") }}
                {{ form.weight_kg(class="form-control") }}
            </div>
            <div class="col-lg-2">
                {{ form.waist_cm.label(class="form-label") }}
                {{ form.waist_cm(class="form-control") }}
            </div>
            {% endif %}
            <div class="col-lg-2">
                {{ form.body_fat_percentage.label(class="form-label") }}
                {{ form.body_fat_percentage(class="form-control") }}
            </div>
            <div class="col-lg-2">
                {{ form.submit(class="btn btn-outline-primary w-100") }}
            </div>
        </div>
    </form>

    <h2 class="mb-4">History</h2>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Weight</th>
                    <th>Waist</th>
                    <th>Body Fat %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in check_ins.items %}
                <tr>
                    <form method="POST" action="{{ url_for('tracking.update_check_in', check_in_id=item.id) }}">
                        {{ forms[item.id].hidden_tag() }}
                        <td>{{ forms[item.id].checkin_date(class="form-control") }}</td>
                        {% if current_user.measurement_system == 'us' %}
                        <td>{{ forms[item.id].weight_lbs(class="form-control") }}</td>
                        <td>{{ forms[item.id].waist_in(class="form-control") }}</td>
                        {% else %}
                        <td>{{ forms[item.id].weight_kg(class="form-control") }}</td>
                        <td>{{ forms[item.id].waist_cm(class="form-control") }}</td>
                        {% endif %}
                        <td>{{ forms[item.id].body_fat_percentage(class="form-control") }}</td>
                        <td>
                            <button type="submit" class="btn btn-sm btn-outline-success">Save</button>
                    </form>
                    <form action="{{ url_for('tracking.delete_check_in', check_in_id=item.id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if check_ins.has_prev %}
            <li class="page-item"><a class="page-link" href="{{ url_for('tracking.progress', page=check_ins.prev_num) }}">Previous</a></li>
            {% endif %}
            {% for page_num in check_ins.iter_pages() %}
            {% if page_num %}
            <li class="page-item {% if page_num == check_ins.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('tracking.progress', page=page_num) }}">{{ page_num }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            {% endfor %}
            {% if check_ins.has_next %}
            <li class="page-item"><a class="page-link" href="{{ url_for('tracking.progress', page=check_ins.next_num) }}">Next</a></li>
            {% endif %}
        </ul>
    </nav>
</div>

{% if chart_labels and weight_data %}
<script>
    const ctx = document.getElementById('progressChart');
    const labels = {{ chart_labels|tojson }};
    const weightData = {{ weight_data|tojson }};
    const goalWeight = {{ goal_weight|tojson }};

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Weight (kg)',
                data: weightData,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }, {
                label: 'Goal (kg)',
                data: Array(labels.length).fill(goalWeight),
                borderColor: 'rgb(255, 99, 132)',
                borderDash: [5, 5],
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
