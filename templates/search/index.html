{% extends "base.html" %}

{% block content %}
    <h1>Unified Search</h1>

    <form method="get" action="{{ url_for('search.search') }}" class="mb-4">
        <div class="input-group">
            <input type="text" name="search_term" class="form-control" placeholder="Search for a food..." value="{{ search_term or '' }}">
            <button class="btn btn-outline-primary" type="submit">Search</button>
            <button class="btn btn-outline-secondary" type="button" id="scan-barcode-btn">Scan Barcode</button>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="search_my_foods" name="search_my_foods" value="true" {% if search_my_foods %}checked{% endif %}>
            <label class="form-check-label" for="search_my_foods">Foods</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="search_my_meals" name="search_my_meals" value="true" {% if search_my_meals %}checked{% endif %}>
            <label class="form-check-label" for="search_my_meals">Meals</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="search_recipes" name="search_recipes" value="true" {% if search_recipes %}checked{% endif %}>
            <label class="form-check-label" for="search_recipes">Recipes</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="search_usda" name="search_usda" value="true" {% if search_usda %}checked{% endif %}>
            <label class="form-check-label" for="search_usda">USDA</label>
        </div>
    </form>

    <!-- Barcode Scanner Modal -->
    <div class="modal fade" id="barcodeScannerModal" tabindex="-1" aria-labelledby="barcodeScannerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="barcodeScannerModalLabel">Scan Barcode</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body"
                     data-target="{{ target or '' }}"
                     data-log-date="{{ log_date or '' }}"
                     data-meal-name="{{ meal_name or '' }}"
                     data-recipe-id="{{ recipe_id or '' }}">
                    <div id="reader" style="width: 100%;"></div>
                    <div id="scanner-result-display" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    {% if search_term %}
        <h2>Search Results</h2>

        {% if results.my_foods %}
            <div class="card mb-3">
                <div class="card-header">Foods</div>
                <ul class="list-group list-group-flush">
                    {% for food in results.my_foods %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ food.description }}</strong>
                                {% if food.user.username != current_user.username %}
                                    <span class="badge bg-secondary">by {{ food.user.username }}</span>
                                {% endif %}
                                <small class="d-block text-muted">
                                    {% if food.portions %}<span class="me-2 fw-bold text-primary" title="Portion sizes available">P</span>{% endif %}
                                    {% if food.ingredients %}<span class="me-2 fw-bold text-success" title="Ingredients list available">I</span>{% endif %}
                                </small>
                            </div>
                            <div class="d-flex align-items-center">
                                {% if target %}
                                    <form method="post" action="{{ url_for('search.add_item') }}" class="d-inline-flex align-items-center me-2">
                                        <input type="hidden" name="target" value="{{ target }}">
                                        <input type="hidden" name="log_date" value="{{ log_date }}">
                                        <input type="hidden" name="meal_name" value="{{ meal_name }}">
                                        <input type="hidden" name="recipe_id" value="{{ recipe_id }}">
                                        <input type="hidden" name="food_type" value="my_food">
                                        <input type="hidden" name="food_id" value="{{ food.id }}">
                                        <input type="number" name="amount" class="form-control form-control-sm" value="100" style="width: 70px;">
                                        <select name="portion_id" class="form-select form-select-sm" style="width: auto;">
                                            <option value="g">g</option>
                                            {% for portion in food.portions %}
                                                <option value="{{ portion.id }}">{{ portion.full_description_str }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-outline-success ms-2">Add</button>
                                    </form>
                                {% endif %}
                                {% if food.user_id == current_user.id %}
                                    <a href="{{ url_for('my_foods.edit_my_food', food_id=food.id) }}" class="btn btn-sm btn-outline-info">Edit</a>
                                {% else %}
                                    <form method="post" action="{{ url_for('my_foods.copy_my_food', food_id=food.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success">Copy</button>
                                    </form>
                                {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if results.my_meals %}
            <div class="card mb-3">
                <div class="card-header">Meals</div>
                <ul class="list-group list-group-flush">
                    {% for searched_meal in results.my_meals %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ searched_meal.name }}</strong>
                                <small class="d-block text-muted">
                                    <span class="me-2 fw-bold text-info" title="Contains items">M</span>
                                </small>
                            </div>
                            <div class="d-flex align-items-center">
                                {% if target %}
                                <form method="post" action="{{ url_for('search.add_item') }}" class="d-inline-flex align-items-center me-2">
                                    <input type="hidden" name="target" value="{{ target }}">
                                    <input type="hidden" name="log_date" value="{{ log_date }}">
                                    <input type="hidden" name="meal_name" value="{{ meal_name }}">
                                    <input type="hidden" name="food_type" value="my_meal">
                                    <input type="hidden" name="food_id" value="{{ searched_meal.id }}">
                                    <button type="submit" class="btn btn-sm btn-outline-success">Add</button>
                                </form>
                                {% endif %}
                                <a href="{{ url_for('diary.edit_meal', meal_id=searched_meal.id) }}" class="btn btn-sm btn-outline-info">Edit</a>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if results.recipes %}
            <div class="card mb-3">
                <div class="card-header">Recipes</div>
                <ul class="list-group list-group-flush">
                    {% for recipe in results.recipes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ recipe.name }}</strong>
                                {% if recipe.user.username != current_user.username %}
                                    <span class="badge bg-secondary">by {{ recipe.user.username }}</span>
                                {% endif %}
                                {% if recipe.is_public %}
                                    <span class="badge bg-info text-dark">Public</span>
                                {% endif %}
                                <small class="d-block text-muted">
                                    {% if recipe.portions %}<span class="me-2 fw-bold text-primary" title="Portion sizes available">P</span>{% endif %}
                                    {% if recipe.ingredients %}<span class="me-2 fw-bold text-success" title="Ingredients list available">I</span>{% endif %}
                                </small>
                            </div>
                            <div class="d-flex align-items-center">
                                {% if target %}
                                <form method="post" action="{{ url_for('search.add_item') }}" class="d-inline-flex align-items-center me-2">
                                    <input type="hidden" name="target" value="{{ target }}">
                                    <input type="hidden" name="log_date" value="{{ log_date }}">
                                    <input type="hidden" name="meal_name" value="{{ meal_name }}">
                                    <input type="hidden" name="recipe_id" value="{{ recipe_id }}">
                                    <input type="hidden" name="food_type" value="recipe">
                                    <input type="hidden" name="food_id" value="{{ recipe.id }}">
                                    <input type="number" name="amount" class="form-control form-control-sm" value="1" style="width: 70px;">
                                    <select name="portion_id" class="form-select form-select-sm" style="width: auto;">
                                        <option value="g">g</option>
                                        {% for portion in recipe.portions %}
                                            <option value="{{ portion.id }}">{{ portion.full_description_str }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-outline-success ms-2">Add</button>
                                </form>
                                {% endif %}
                                {% if recipe.user_id == current_user.id %}
                                    <a href="{{ url_for('recipes.edit_recipe', recipe_id=recipe.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                {% endif %}
                                <a href="{{ url_for('recipes.view_recipe', recipe_id=recipe.id) }}" class="btn btn-sm btn-outline-info">View</a>
                                {% if recipe.user_id != current_user.id %}
                                    <form method="post" action="{{ url_for('recipes.copy_recipe', recipe_id=recipe.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success">Copy</button>
                                    </form>
                                {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if results.usda_foods %}
            <div class="card mb-3">
            <h3>USDA Foods</h3>
            <ul class="list-group list-group-flush">
                {% for food in results.usda_foods %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ food.description }}</strong>
                            <div class="text-muted small">
                                {% if food.portions %}<span class="me-2 fw-bold text-primary" title="Portion sizes available">P</span>{% endif %}
                                {% if food.ingredients %}<span class="me-2 fw-bold text-success" title="Ingredients list available">I</span>{% endif %}
                                {% if food.nutrients %}<span class="me-2 fw-bold text-warning" title="Rich nutritional data">N</span>{% endif %}
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <form method="post" action="{{ url_for('search.add_item') }}" class="d-inline-flex align-items-center me-2">
                                <input type="hidden" name="target" value="{{ target }}">
                                <input type="hidden" name="log_date" value="{{ log_date }}">
                                <input type="hidden" name="meal_name" value="{{ meal_name }}">
                                <input type="hidden" name="recipe_id" value="{{ recipe_id }}">
                                <input type="hidden" name="food_type" value="usda">
                                <input type="hidden" name="food_id" value="{{ food.fdc_id }}">
                                <input type="number" name="amount" class="form-control form-control-sm" value="100" style="width: 70px;">
                                <select name="portion_id" class="form-select form-select-sm" style="width: auto;">
                                    <option value="g">g</option>
                                    {% for portion in food.portions %}
                                        <option value="{{ portion.id }}">{{ portion.full_description_str }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-sm btn-outline-success ms-2">Add</button>
                            </form>
                            <form method="post" action="{{ url_for('my_foods.copy_my_food', food_id=food.fdc_id) }}" class="d-inline">
                                <input type="hidden" name="fdc_id" value="{{ food.fdc_id }}">
                                <button type="submit" class="btn btn-sm btn-outline-primary">Add to My Foods</button>
                            </form>
                            <a href="{{ food.detail_url }}" class="btn btn-sm btn-outline-info">View Details</a>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            </div>
        {% endif %}

        {% if not results.my_foods and not results.recipes and not results.usda_foods and not results.my_meals %}
            <p>No results found for "{{ search_term }}".</p>
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='html5-qrcode.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const scanButton = document.getElementById('scan-barcode-btn');
    const scannerModalElement = document.getElementById('barcodeScannerModal');
    const resultDisplay = document.getElementById('scanner-result-display');
    const modalBody = scannerModalElement.querySelector('.modal-body');
    const scannerModal = new bootstrap.Modal(scannerModalElement);
    let html5QrCode;

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Scan result: ${decodedText}`, decodedResult);
        
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(ignore => {
                lookupBarcode(decodedText);
            }).catch(err => {
                console.error("Error stopping scanner:", err);
                lookupBarcode(decodedText); // Proceed anyway
            });
        } else {
            lookupBarcode(decodedText);
        }
    }

    function lookupBarcode(barcode) {
        resultDisplay.innerHTML = `<div class="alert alert-info">Found barcode: ${barcode}. Looking up...</div>`;

        fetch(`/upc/${barcode}`)
            .then(response => {
                if (!response.ok) { throw new Error('UPC not found'); }
                return response.json();
            })
            .then(data => {
                if (data.status === 'found') {
                    const target = modalBody.dataset.target;
                    if (target) {
                        // If there's a target, show the 'Add' form
                        displayFoodForAdding(data);
                    } else {
                        // Otherwise, redirect to the detail page
                        window.location.href = data.detail_url;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDisplay.innerHTML = `<div class="alert alert-danger">Could not find a product with UPC ${barcode}.</div>`;
            });
    }

    function displayFoodForAdding(foodData) {
        let portionsOptions = '<option value="g">g</option>';
        foodData.portions.forEach(p => {
            portionsOptions += `<option value="${p.id}">${p.description}</option>`;
        });

        const target = modalBody.dataset.target;
        const logDate = modalBody.dataset.logDate;
        const mealName = modalBody.dataset.mealName;
        const recipeId = modalBody.dataset.recipeId;

        const formHtml = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">${foodData.description}</h5>
                    <form method="post" action="{{ url_for('search.add_item') }}" class="d-flex align-items-center">
                        <input type="hidden" name="target" value="${target}">
                        <input type="hidden" name="log_date" value="${logDate}">
                        <input type="hidden" name="meal_name" value="${mealName}">
                        <input type="hidden" name="recipe_id" value="${recipeId}">
                        <input type="hidden" name="food_type" value="usda">
                        <input type="hidden" name="food_id" value="${foodData.fdc_id}">
                        
                        <input type="number" name="amount" class="form-control form-control-sm" value="100" style="width: 80px;">
                        <select name="portion_id" class="form-select form-select-sm mx-2">
                            ${portionsOptions}
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-success">Add</button>
                    </form>
                </div>
                <img src="${foodData.nutrition_label_svg_url}" alt="Nutrition Label" class="img-fluid mt-2">
            </div>
        `;
        resultDisplay.innerHTML = formHtml;
    }

    function onScanFailure(error) {
        // This callback is called frequently, ignore it.
    }

    scanButton.addEventListener('click', function () {
        resultDisplay.innerHTML = ''; // Clear previous results
        scannerModal.show();
    });

    scannerModalElement.addEventListener('shown.bs.modal', function () {
        resultDisplay.innerHTML = '<div class="alert alert-info">Starting camera...</div>';
        
        const formatsToSupport = [
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128,
        ];
        
        html5QrCode = new Html5Qrcode("reader", { formatsToSupport: formatsToSupport, verbose: false });

        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 150 } 
        };

        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .catch((err) => {
                resultDisplay.innerHTML = `<div class="alert alert-danger">Error starting scanner: ${err}</div>`;
                console.error("Error starting scanner:", err);
            });
    });

    scannerModalElement.addEventListener('hidden.bs.modal', function () {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.log("Ignoring error on stop: ", err));
        }
    });
});
</script>
{% endblock %}

