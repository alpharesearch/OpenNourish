<!doctype html>
<html lang="en" data-bs-theme="{{ current_user.theme_preference if current_user.is_authenticated else 'light' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}OpenNourish{% endblock %}</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='chart.js') }}"></script>
  </head>
  <body>
    {% include '_navbar.html' %}
    <div class="container-md px-0 px-md-2">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
        {% block content %}{% endblock %}
    </div>

    {% if current_user.is_authenticated %}
    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addItemModalLabel">Add Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="addItemForm" action="{{ url_for('search.add_item') }}" method="post">
            <div class="modal-body">
              <p>Adding: <strong id="modalFoodName"></strong></p>
              <input type="hidden" name="food_id" id="modalFoodId">
              <input type="hidden" name="food_type" id="modalFoodType">
              <input type="hidden" name="target" id="modalTarget">
              <input type="hidden" name="recipe_id" id="modalRecipeId">
              <input type="hidden" name="source_log_date" id="modalSourceLogDate">
              <input type="hidden" name="meal_id" id="modalMealId">
              <input type="hidden" name="return_url" id="modalReturnUrl">
              <input type="hidden" name="friend_username" id="modalFriendUsername">

              <div id="diaryFields">
                <div class="mb-3">
                  <label for="modalLogDate" class="form-label">Date</label>
                  <input type="date" class="form-control" id="modalLogDate" name="log_date">
                </div>

                <div class="mb-3">
                  <label for="modalMealName" class="form-label">Meal</label>
                  <select class="form-select" id="modalMealName" name="meal_name">
                    <!-- Options will be populated by JavaScript -->
                  </select>
                </div>
              </div>
              <div id="modalScaleFactorField" class="mb-3" style="display: none;">
                <label for="modalAmount" class="form-label">Scale Factor</label>
                <input type="number" step="0.001" class="form-control" id="modalScaleFactor" name=                 
                "scale_factor" value="1">
              </div>
              <div id="modalAmountPortionFields">
                <div class="row">
                  <div class="col">
                    <div class="mb-3">
                      <label for="modalAmount" class="form-label">Quantity</label>
                      <input type="number" step="0.01" class="form-control" id="modalAmount" name="amount" value="1" required>
                    </div>
                  </div>
                  <div class="col">
                    <div class="mb-3">
                      <label for="modalPortionId" class="form-label">Portion</label>
                      <select class="form-select" id="modalPortionId" name="portion_id" required>
                        <!-- Options will be populated by JavaScript -->
                      </select>
                    </div>
                  </div>
                </div>
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-outline-primary">Confirm Add</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
    {% block scripts %}{% endblock %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addItemModalEl = document.getElementById('addItemModal');
            if (addItemModalEl) {
                const addItemModal = new bootstrap.Modal(addItemModalEl);
                const addItemForm = document.getElementById('addItemForm');
                const modalFoodName = document.getElementById('modalFoodName');
                const modalFoodId = document.getElementById('modalFoodId');
                const modalFoodType = document.getElementById('modalFoodType');
                const modalTarget = document.getElementById('modalTarget');
                const modalRecipeId = document.getElementById('modalRecipeId');
                const modalSourceLogDate = document.getElementById('modalSourceLogDate');
            const modalMealId = document.getElementById('modalMealId');
            const modalReturnUrl = document.getElementById('modalReturnUrl');
            const modalFriendUsername = document.getElementById('modalFriendUsername');
            const diaryFields = document.getElementById('diaryFields');
                const modalLogDate = document.getElementById('modalLogDate');
                const modalMealName = document.getElementById('modalMealName');
                const modalPortionId = document.getElementById('modalPortionId');
                const modalAmountPortionFields = document.getElementById('modalAmountPortionFields');
                const modalScaleFactorField = document.getElementById('modalScaleFactorField');

                document.querySelectorAll('.add-item-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        // --- 1. GATHER DATA FROM BUTTON ---
                        const foodId = this.dataset.foodId;
                        const foodType = this.dataset.foodType;
                        const foodName = this.dataset.foodName;
                        const target = this.dataset.target;
                        const recipeId = this.dataset.recipeId || '';
                    const sourceLogDate = this.dataset.sourceLogDate || '';
                    const mealId = this.dataset.mealId || '';
                    const friendUsername = this.dataset.friendUsername || '';
                    const logDate = this.dataset.logDate || '';
                        const mealName = this.dataset.mealName || '';
                        const returnUrl = this.dataset.returnUrl || '';
                        const apiFoodType = foodType === 'usda_food' ? 'usda' : foodType;

                        // --- 2. POPULATE HIDDEN MODAL FIELDS ---
                        modalFoodName.textContent = foodName;
                        modalFoodId.value = foodId;
                        modalFoodType.value = apiFoodType;
                        modalTarget.value = target;
                        modalRecipeId.value = recipeId;
                        modalSourceLogDate.value = sourceLogDate;
                        modalMealId.value = mealId;
                        modalReturnUrl.value = returnUrl;
                        modalFriendUsername.value = friendUsername;

                        // --- 3. HANDLE UI VISIBILITY AND REQUIRED FIELDS ---
                        const isDiaryTarget = target === 'diary';
                        diaryFields.style.display = isDiaryTarget ? 'block' : 'none';
                        modalLogDate.required = isDiaryTarget;
                        modalMealName.required = isDiaryTarget;

                        const isMyMeal = apiFoodType === 'my_meal';
                        modalScaleFactorField.style.display = isMyMeal ? 'block' : 'none';

                        const isPortionless = isMyMeal || apiFoodType === 'diary_meal';
                        modalAmountPortionFields.style.display = isPortionless ? 'none' : 'block';
                        modalPortionId.required = !isPortionless;

                        // --- 4. POPULATE DIARY-SPECIFIC FIELDS (DATE & MEAL) ---
                        if (isDiaryTarget) {
                            // Set date: Use the button's specific logDate if provided, otherwise default to today.
                            modalLogDate.value = logDate || '{{ current_log_date_str }}';

                            // Populate meal dropdown
                            modalMealName.innerHTML = '';
                            const globalStandardMealNames = {{ standard_meal_names|tojson }};

                            if (apiFoodType === 'diary_meal') {
                                // Special Case: Copying a meal. The backend will validate if the source and target are the same.
                                const sourceMealName = this.dataset.foodId;
                                for (const meal of globalStandardMealNames) {
                                    if (meal !== 'Water') {
                                        const option = document.createElement('option');
                                        option.value = meal;
                                        option.textContent = meal;
                                        modalMealName.appendChild(option);
                                    }
                                }
                            } else {
                                // Standard Case: Adding any other item.
                                for (const meal of globalStandardMealNames) {
                                    const option = document.createElement('option');
                                    option.value = meal;
                                    option.textContent = meal;
                                    modalMealName.appendChild(option);
                                }
                                // If a mealName was passed from the button, pre-select it.
                                if (mealName) {
                                    modalMealName.value = mealName;
                                }
                            }
                        }

                        // --- 5. FETCH PORTIONS (IF APPLICABLE) ---
                        if (!isPortionless) {
                            modalPortionId.innerHTML = '<option>Loading...</option>';
                            fetch(`/search/api/get-portions/${apiFoodType}/${foodId}`)
                                .then(response => {
                                    if (!response.ok) {
                                        return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    modalPortionId.innerHTML = '';
                                    if (data.error) { throw new Error(data.error); }
                                    data.forEach(portion => {
                                        const option = document.createElement('option');
                                        option.value = portion.id;
                                        option.textContent = portion.description;
                                        if (portion.is_default) {
                                            option.selected = true;
                                        }
                                        modalPortionId.appendChild(option);
                                    });
                                })
                                .catch(error => {
                                    modalPortionId.innerHTML = '';
                                    const option = document.createElement('option');
                                    option.textContent = 'Error loading portions';
                                    modalPortionId.appendChild(option);
                                    console.error('Error fetching portions:', error.message);
                                });
                        } else {
                            modalPortionId.innerHTML = ''; // Clear portions dropdown for portionless items
                        }

                        // --- 6. SHOW MODAL ---
                        addItemModal.show();
                    });
                });
            }

            // The form will now submit normally, allowing the browser to handle the redirect and display the flash message.

            const htmlTag = document.documentElement;
            const userThemePreference = htmlTag.getAttribute('data-bs-theme');

            if (userThemePreference === 'auto') {
                const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDarkMode) {
                    htmlTag.setAttribute('data-bs-theme', 'dark');
                } else {
                    htmlTag.setAttribute('data-bs-theme', 'light');
                }
            }
        });
    </script>
    {% if current_user.is_authenticated and current_user.timezone == 'UTC' %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (userTimezone) {
                fetch("{{ url_for('settings.set_timezone') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ timezone: userTimezone }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Timezone set to:', userTimezone);
                        // Optionally, reload the page to apply the new timezone immediately
                        // window.location.reload();
                    }
                })
                .catch((error) => {
                    console.error('Error setting timezone:', error);
                });
            }
        });
    </script>
    {% endif %}
  </body>
</html>